# RBS for music/scales.rb - Musical scale system framework

module Musa
  module Scales
    # Scale system registry module.
    module Scales
      # Registers a scale system.
      def self.register: (singleton(ScaleSystem) scale_system, ?default: bool?) -> self

      # Retrieves a registered scale system by ID.
      def self.[]: (Symbol id) -> singleton(ScaleSystem)

      # Returns the default scale system.
      def self.default_system: () -> singleton(ScaleSystem)

      # Extends metadata for a scale kind by ID.
      def self.extend_metadata: (Symbol scale_kind_id, **untyped metadata) -> Hash[Symbol, untyped]
    end

    # Abstract base class for musical scale systems.
    class ScaleSystem
      # Returns the unique identifier for this scale system.
      def self.id: () -> Symbol

      # Returns the number of notes in one octave.
      def self.notes_in_octave: () -> Integer

      # Returns the size of the smallest pitch unit.
      def self.part_of_tone_size: () -> Integer

      # Returns available intervals as name-to-offset mapping.
      def self.intervals: () -> Hash[Symbol, Integer]

      # Calculates frequency for a given pitch.
      def self.frequency_of_pitch: (Numeric pitch, Numeric root_pitch, Numeric a_frequency) -> Float

      # Returns the default A frequency.
      def self.default_a_frequency: () -> Float

      # Creates or retrieves a tuning for this scale system.
      def self.[]: (Numeric a_frequency) -> ScaleSystemTuning

      # Returns semitone offset for a named interval.
      def self.offset_of_interval: (Symbol name) -> Integer

      # Returns the default tuning (A=440Hz).
      def self.default_tuning: () -> ScaleSystemTuning

      # Registers a scale kind with this system.
      def self.register: (singleton(ScaleKind) scale_kind_class) -> self

      # Retrieves a registered scale kind by ID.
      def self.scale_kind_class: (Symbol id) -> singleton(ScaleKind)

      # Checks if a scale kind is registered.
      def self.scale_kind_class?: (Symbol id) -> bool

      # Returns all registered scale kinds.
      def self.scale_kind_classes: () -> Hash[Symbol, singleton(ScaleKind)]

      # Returns the chromatic scale kind class.
      def self.chromatic_class: () -> singleton(ScaleKind)

      def ==: (untyped other) -> bool
    end

    # Scale system with specific A frequency tuning.
    class ScaleSystemTuning
      def initialize: (singleton(ScaleSystem) scale_system, Numeric a_frequency) -> void

      # Delegated methods from scale system
      def notes_in_octave: () -> Integer
      def offset_of_interval: (Symbol name) -> Integer

      attr_reader a_frequency: Float
      attr_reader scale_system: singleton(ScaleSystem)

      # Access scale kind by ID.
      def []: (Symbol scale_kind_class_id) -> ScaleKind

      # Returns chromatic scale kind.
      def chromatic: () -> ScaleKind

      # Calculates frequency for pitch.
      def frequency_of_pitch: (Numeric pitch, Numeric root) -> Float

      # Returns scale kinds matching metadata criteria.
      def scale_kinds: (**untyped metadata_criteria) ?{ (singleton(ScaleKind)) -> bool } -> Array[ScaleKind]

      # Searches for a chord across multiple scale types.
      def chords_of: (Chords::Chord chord, ?roots: (Range[Integer] | Array[Integer])?, **untyped metadata_criteria) -> Array[Chords::Chord]

      def ==: (untyped other) -> bool
      def inspect: () -> String
      alias to_s inspect
    end

    # Abstract base class for scale types.
    class ScaleKind
      def initialize: (ScaleSystemTuning tuning) -> void

      attr_reader tuning: ScaleSystemTuning

      # Creates or retrieves a scale rooted on specific pitch.
      def []: (Integer root_pitch) -> Scale

      # Returns scale with default root (middle C).
      def default_root: () -> Scale

      # Returns scale with absolute root (MIDI 0).
      def absolut: () -> Scale

      # Finds all scales of this kind containing the chord.
      def scales_containing: (Chords::Chord chord, ?roots: (Range[Integer] | Array[Integer])?) -> Array[Chords::Chord]

      def ==: (untyped other) -> bool
      def inspect: () -> String
      alias to_s inspect

      # Class methods for scale kind definition
      def self.id: () -> Symbol
      def self.pitches: () -> Array[Hash[Symbol, untyped]]
      def self.chromatic?: () -> bool
      def self.grades: () -> Integer
      def self.grade_of_function: (Symbol symbol) -> Integer?
      def self.grades_functions: () -> Array[Symbol]

      # Metadata methods
      def self.intrinsic_metadata: () -> Hash[Symbol, untyped]
      def self.base_metadata: () -> Hash[Symbol, untyped]
      def self.custom_metadata: () -> Hash[Symbol, untyped]
      def self.extend_metadata: (**untyped metadata) -> Hash[Symbol, untyped]
      def self.reset_custom_metadata: () -> nil
      def self.metadata: () -> Hash[Symbol, untyped]
      def self.metadata_value: (Symbol key) -> untyped
      def self.has_metadata?: (Symbol key, ?untyped? value) -> bool
    end

    # Instantiated scale with specific root pitch.
    class Scale
      def initialize: (ScaleKind kind, root_pitch: Integer) -> void

      # Delegated methods from kind
      def tuning: () -> ScaleSystemTuning

      attr_reader kind: ScaleKind
      attr_reader root_pitch: Integer

      # Returns the root note.
      def root: () -> NoteInScale

      # Returns the chromatic scale at the same root.
      def chromatic: () -> Scale

      # Returns the scale rooted at absolute pitch 0.
      def absolut: () -> Scale

      # Transposes scale by octaves.
      def octave: (Integer octave) -> Scale

      # Accesses scale degree by grade, symbol, or function name.
      def []: (Integer | Symbol | String grade_or_symbol) -> NoteInScale

      # Converts grade specifier to numeric grade and accidentals.
      def grade_of: (Integer | Symbol | String grade_or_string_or_symbol) -> [Integer, Integer]

      # Parses grade string/symbol into components.
      def parse_grade: (Integer | Symbol | String neuma_grade) -> [Symbol?, Integer?, Integer]

      # Finds note for a specific MIDI pitch.
      def note_of_pitch: (Integer pitch, ?allow_chromatic: bool?, ?allow_nearest: bool?) -> NoteInScale?

      # Returns semitone offset for a named interval.
      def offset_of_interval: (Symbol interval_name) -> Integer

      # Checks if all chord pitches exist in this scale.
      def contains_chord?: (Chords::Chord chord) -> bool

      # Returns the grade where the chord root falls in this scale.
      def degree_of_chord: (Chords::Chord chord) -> Integer?

      # Creates an equivalent chord with this scale as context.
      def chord_on: (Chords::Chord chord) -> Chords::Chord?

      def ==: (untyped other) -> bool
      def inspect: () -> String
      alias to_s inspect
    end

    # Note within a scale context.
    class NoteInScale
      def initialize: (
        Scale scale,
        Integer grade,
        Integer octave,
        Numeric pitch,
        ?background_scale: Scale?,
        ?background_grade: Integer?,
        ?background_octave: Integer?,
        ?background_sharps: Integer?
      ) -> void

      attr_reader grade: Integer
      attr_reader pitch: Numeric

      # Returns function names for this scale degree.
      def functions: () -> Array[Symbol]

      # Transposes note or returns current octave.
      def octave: (?Integer? octave, ?absolute: bool) -> (Integer | NoteInScale)

      # Creates a copy with background scale context.
      def with_background: (scale: Scale, ?grade: Integer?, ?octave: Integer?, ?sharps: Integer?) -> NoteInScale

      attr_reader background_scale: Scale?

      # Returns the diatonic note this chromatic note is based on.
      def background_note: () -> NoteInScale?

      attr_reader background_sharps: Integer?

      # Returns wide grade.
      def wide_grade: () -> Integer

      # Navigates upward by interval.
      def up: (Symbol | Integer interval_name_or_interval, ?Symbol? natural_or_chromatic, ?sign: Integer?) -> NoteInScale

      # Navigates downward by interval.
      def down: (Symbol | Integer interval_name_or_interval, ?Symbol? natural_or_chromatic) -> NoteInScale

      # Raises note by semitones.
      def sharp: (?Integer? count) -> NoteInScale

      # Lowers note by semitones.
      def flat: (?Integer? count) -> NoteInScale

      # Calculates frequency in Hz.
      def frequency: () -> Float

      # Changes scale while keeping pitch, or returns current scale.
      def scale: (?Symbol | ScaleKind? kind_id_or_kind) -> (Scale | NoteInScale)

      # Finds this note in another scale.
      def on: (Scale scale) -> NoteInScale?

      # Builds a chord rooted on this note.
      def chord: (
        *Symbol feature_values,
        ?allow_chromatic: bool?,
        ?move: Hash[Symbol, Integer]?,
        ?duplicate: Hash[Symbol, Integer | Array[Integer]]?,
        **Symbol features_hash
      ) -> Chords::Chord

      def ==: (untyped other) -> bool
      def inspect: () -> String
      alias to_s inspect
    end
  end
end
