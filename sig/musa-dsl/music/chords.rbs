# RBS for music/chords.rb and chord-definition.rb - Chord framework

module Musa
  module Chords
    # Chord template defining structure and features.
    class ChordDefinition
      # Retrieves a registered chord definition by name.
      def self.[]: (Symbol name) -> ChordDefinition?

      # Registers a new chord definition.
      def self.register: (Symbol name, offsets: Hash[Symbol, Integer], **Symbol features) -> singleton(ChordDefinition)

      # Finds chord definition matching a set of pitches.
      def self.find_by_pitches: (Array[Integer] pitches) -> ChordDefinition?

      # Converts feature values to feature hash.
      def self.features_from: (?Array[Symbol]? values, ?Hash[Symbol, Symbol]? hash) -> Hash[Symbol, Symbol]

      # Finds definitions matching specified features.
      def self.find_by_features: (*Symbol values, **Symbol hash) -> Array[ChordDefinition]

      # Returns feature key for a feature value.
      def self.feature_key_of: (Symbol feature_value) -> Symbol

      # Returns all registered feature values.
      def self.feature_values: () -> Array[Symbol]

      # Returns all registered feature keys.
      def self.feature_keys: () -> Set[Symbol]

      def initialize: (Symbol name, offsets: Hash[Symbol, Integer], **Symbol features) -> void

      # Chord name.
      attr_reader name: Symbol

      # Chord features (quality, size, etc.).
      attr_reader features: Hash[Symbol, Symbol]

      # Semitone offsets by position name.
      attr_reader pitch_offsets: Hash[Symbol, Integer]

      # Position names by semitone offset.
      attr_reader pitch_names: Hash[Integer, Symbol]

      # Calculates chord pitches from root pitch.
      def pitches: (Integer root_pitch) -> Array[Integer]

      # Checks if chord fits within a scale.
      def in_scale?: (Scales::Scale scale, chord_root_pitch: Integer) -> bool

      # Maps elements to named chord positions.
      def named_pitches: [T] (Array[T] elements_or_pitches) ?{ (T) -> Integer } -> Hash[Symbol, Array[T]]

      # Checks if pitches match this chord definition.
      def matches: (Array[Integer] pitches) -> bool

      def inspect: () -> String
      alias to_s inspect
    end

    # Instantiated chord with specific root and scale context.
    class Chord
      # Creates a chord with specified root.
      def self.with_root: (
        Scales::NoteInScale | Integer | Symbol root_note_or_pitch_or_symbol,
        ?scale: Scales::Scale?,
        ?allow_chromatic: bool,
        ?name: Symbol?,
        ?move: Hash[Symbol, Integer]?,
        ?duplicate: Hash[Symbol, Integer | Array[Integer]]?,
        **Symbol features
      ) -> Chord

      # Scale context (nil if chord contains non-diatonic notes).
      attr_reader scale: Scales::Scale?

      # Chord definition template.
      attr_reader chord_definition: ChordDefinition

      # Octave moves applied to positions (returns current settings when no args).
      def move: (**Integer octaves) -> (Chord | Hash[Symbol, Integer])

      # Octave duplications applied to positions (returns current settings when no args).
      def duplicate: (**(Integer | Array[Integer]) octaves) -> (Chord | Hash[Symbol, Integer | Array[Integer]])

      # Returns chord notes sorted by pitch.
      def notes: () -> Array[untyped]

      # Returns MIDI pitches of chord notes.
      def pitches: (*Symbol grades) -> Array[Integer]

      # Returns chord features.
      def features: () -> Hash[Symbol, Symbol]

      # Creates new chord with modified features.
      def featuring: (*Symbol values, ?allow_chromatic: bool, **Symbol hash) -> Chord

      # Transposes entire chord to a different octave.
      def octave: (Integer octave) -> Chord

      # Finds this chord in other scales.
      def in_scales: (?roots: (Range[Integer] | Array[Integer])?, **untyped metadata) -> Array[Chord]

      def ==: (untyped other) -> bool
      def inspect: () -> String
      alias to_s inspect
    end
  end
end
