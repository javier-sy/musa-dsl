# RBS for generative/generative-grammar.rb - Formal grammar system

module Musa
  module GenerativeGrammar
    extend GenerativeGrammar

    # Creates a terminal or block node.
    def N: (?untyped? content, **untyped attributes) ?{ (Array[OptionElement] parent, ?Hash[Symbol, untyped] attributes) -> untyped } -> Implementation::Node

    # Creates a proxy node for recursive grammars.
    def PN: () -> Implementation::ProxyNode

    # Container for generated option elements.
    class OptionElement
      # Element content
      attr_reader content: untyped

      # Element attributes
      attr_reader attributes: Hash[Symbol, untyped]

      def initialize: (untyped content, ?Hash[Symbol, untyped]? attributes) -> void
    end

    module Implementation
      # Base node class for grammar elements.
      class Node
        # Creates alternation between this node and another.
        def or: (Node other) -> OrNode
        alias | or

        # Repeats this node with optional min/max bounds.
        def repeat: (?Integer? exactly, ?min: Integer?, ?max: Integer?) -> Node

        # Limits generated options by condition.
        def limit: (
          ?Symbol? attribute,
          ?Symbol? after_collect_operation,
          ?Symbol? comparison_method,
          ?untyped? comparison_value
        ) ?{ (Array[OptionElement]) -> bool } -> ConditionNode

        # Creates sequence of this node followed by another.
        def next: (Node other) -> NextNode
        alias + next

        # Generates all options from this grammar node.
        def options: (
          ?Symbol? attribute,
          ?Symbol? after_collect_operation,
          ?Symbol? comparison_method,
          ?untyped? comparison_value,
          ?raw: bool?,
          ?content: Symbol?
        ) ?{ (Array[OptionElement]) -> bool } -> Array[untyped]

        # Counts number of options generated by this node.
        def size: () -> Integer
        alias length size

        # Gets option at index as series node.
        def []: (Integer index) -> Node

        # Converts options to series.
        def to_serie: (?flatten: bool) ?{ (Array[OptionElement]) -> bool } -> Musa::Series::_SerieProtocol
        alias s to_serie

        # Internal method to generate option arrays.
        def _options: (?parent: Array[OptionElement]?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end

      # Proxy node for recursive grammar references.
      class ProxyNode < Node
        # Assigned node
        attr_accessor node: Node?

        def _options: (?parent: Array[OptionElement]?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end

      # Terminal node with fixed content.
      class FinalNode < Node
        # Node content
        attr_reader content: untyped

        # Node attributes
        attr_reader attributes: Hash[Symbol, untyped]

        def initialize: (untyped content, Hash[Symbol, untyped] attributes) -> void

        def _options: (?parent: Array[OptionElement]?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end

      # Node with dynamic content generated by block.
      class BlockNode < Node
        def initialize: (Hash[Symbol, untyped] attributes) { (Array[OptionElement], Hash[Symbol, untyped]) -> untyped } -> void

        def _options: (?parent: Array[OptionElement]?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end

      # Node that filters child node options by condition.
      class ConditionNode < Node
        def initialize: (Node node) { (Array[OptionElement]) -> bool } -> void

        def _options: (?parent: Array[OptionElement]?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end

      # Node representing alternation between two nodes.
      class OrNode < Node
        def initialize: (Node node1, Node node2) -> void

        def _options: (?parent: Array[OptionElement]?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end

      # Node representing sequence of two nodes.
      class NextNode < Node
        def initialize: (Node node, Node after) -> void

        def _options: (?parent: Array[OptionElement]?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end

      # Node representing repetition of a node.
      class RepeatNode < Node
        def initialize: (Node node, ?Integer? max) -> void

        def _options: (?parent: Array[OptionElement]?, ?depth: Integer?) ?{ (Array[OptionElement]) -> bool } -> Array[Array[OptionElement]]
      end
    end
  end
end
